<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>Time Series: Events</title>
	<link rel="stylesheet" type="text/css" href="css/widgets.css"/>
	<link rel="stylesheet" type="text/css" href="css/ui-lightness/jquery-ui-1.8.13.custom.css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="language" content="en" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<script src="js/jquery-1.5.1.min.js" type="text/javascript"></script>
	<script src="js/jquery-ui-1.8.13.custom.min.js" type="text/javascript"></script>
	<script src="js/common.js" type="text/javascript"></script>
<!--
	<script src="js/reportgrid-core.js?tokenId=A3BC1539-E8A9-4207-BB41-3036EC2C6E6D&amp;analyticsServer=http%3A%2F%2F127.0.0.1%3A8888%2F&amp;useJsonp=true" type="text/javascript"></script>
-->
	<script src="js/reportgrid-core.js?tokenId=A3BC1539-E8A9-4207-BB41-3036EC2C6E6D&analyticsServer=http%3A%2F%2Fapi.reportgrid.com%2Fservices%2Fanalytics%2Fv0%2F&useJsonp=true" type="text/javascript"></script>
	<script src="js/reportgrid-viz.js" type="text/javascript"></script>
	<script type="text/javascript">
$(document).ready(function() {
	var basepath ="/prod";
	
	var end, metric1, metric2, metrics = 2, pathparts = [];
	
	function path() {
		return [basepath].concat(pathparts).join('/').replace('//', '/');
	};
	
	setPath = function(s)
	{
		if(s == '/')
		{
			pathparts = [];
		} else {
			pathparts = s.split('/');
			pathparts.pop();
			pathparts = pathparts.map(function(d) { return d + "/"; });
			console.log(pathparts);
		}
		updatePath();
		buildChart();
	}
	
	function displaypath() {
		var c = pathparts.copy(),
			last = c.pop(),
			p = '';
		return '<a href="#" onclick="setPath(\'/\')">/</a>' 
			+ c.map(function(d) {
				return '<a href="#" onclick="setPath(\''+(p += d)+'\')">' + d +'</a>';
			}).join('')
			+ (null == last ? '' : '<span class="current">'+last+'</span>');
	};
	
	$('#rootoptions').change(function() {
		var v = $(this).val();
		if(v)
		{
			pathparts.push(v);
			updatePath();
			buildChart();
		}
	});
	
	function updatePath()
	{
		ReportGrid.children(path(), { type : "path" }, function(children) {
			$('#rootpath').html(displaypath());
			var options = children.map(function(v) { return '<option value="'+v+'">'+v+'</option>'; });
			$('#rootoptions').html('<option value="">- select child -</option>' + options.join(''))
			feedOptionsEvent(path(), "#event");
			loadEvents(path(), function(events) {
				for(var i = 0; i < metrics; i++)
				{
					$('#metric'+i).html(buildOptions(events, "select metric " + (i+1))); 
				}
			});
		});
	}
	
	updatePath();
	
	$('#start').datepicker().change(function() {
		start = $(this).val();
		buildChart();
	});
	
	$('#end').datepicker().change(function() {
		end = $(this).val();
		buildChart();
	});
	
	for(var i = 0; i < metrics; i++)
	{
		$('#metric'+i).change(buildChart); 
	}

	function buildChart()
	{
		if(!start || !end)
			return;
		var query = [];
		for(var i = 0; i < metrics; i++)
		{
			var v = $('#metric' + i).val();
			if(v)
			{
				query.push({
					path : path(),
					event : v
				});
			}
		}
		
		if(query.length == 0)
		{
			$('#chart').html('');
			return;
		}
		
		ReportGrid.timeSeries("#chart", query, {
			start : start,
			end : end,
			lineinterpolator : "cardinal-0.85"
		});
	}
	
	function pickDateRange()
	{
		var value = $('#select-date').val();
		if(value == '-')
		{
			$('#dates').css('display', 'block');
			start = $('#start').val();
			end = $('#end').val();
		} else 
		{
			$('#dates').css('display', 'none');
			var parts = value.split('/');
			if('' == parts[0])
				start = null;
			else
				start = parts[0];
			end = parts[1];
		}
		buildChart();
	}
	
	$('#select-date').change(function() {
		$(this).find('option:contains(select interval)').remove();
		pickDateRange();
	});
	pickDateRange();
});
	</script>
</head>
<body>
	<div id="main">
		<div id="control-panel">
			<div>
				<label>period:
				<select id="select-date">
					<option value="-select-" selected>- select interval -</option>
					<option value="1 hour ago/now">now</option>
					<option value="2 hour ago/1 hour ago">previous hour</option>
					<option value="1 day ago/now">previous day</option>
					<option value="1 week ago/now">previous week</option>
					<option value="1 month ago/today">month to date</option>
					<option value="/today">campaign to date</option>
					<option value="-">select dates</option>
				</select>
				</label>
			</div>
			<div id="dates" style="display:none">
				<label>start: <input type="date" id="start"/></label>
				<label>end: <input type="date" id="end"/></label>
			</div>
			<div>
				<label>path:
					<span id="breadcrumbs">
						<span id="rootpath"></span>
						<select id="rootoptions"></select>
					</span>
				</label>
			</div>
			<div>
				<label>metrics:
					<select id="metric0"></select>
					<select id="metric1"></select>
				</label>
			</div>
		</div>
		<div id="chart" style="height:450px"></div>
		<div id="logos"></div>
		<div id="haxe:trace"></div>
	</div>
</body>
</html>